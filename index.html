<!DOCTYPE html>
<html lang="en-us">
    <head>
        <title>Biology in JS</title>
        <meta charset="utf-8" />
        <script src="https://d3js.org/d3.v4.min.js"></script>
        <script src="js/general.js"></script>
        <link rel="stylesheet" href="css/style.css" />
    </head>
    <body>
        <header>
            <a href="./index.html"><h1>Genetics in Javascript</h1></a>
        </header>
        <nav>
            <a href="#h-w">Hardy-Weinberg</a>
            <a href="#genDrift">Genetic Drift</a>
            <a href="#mutation">Mutation</a>
            <a href="#fixation">Fixation</a>
            <a href="#migration">Migration</a>
            <a href="#selection">Natural Selection</a>
            <a href="#epidemics">Epidemy model</a>
        </nav>
        <a href="#" class="floatingDirection"><img src="assets/up.png" /></a>
        <main>
            <section id="h-w">
                <h3>Hardy-Weinberg Model</h3>
                <div class="assumptions">infinite population size, random mating, no overlapping generations, mutation or selection</div>
                <div id="hw_output" class="output"></div>
                <script type="text/javascript" src="js/h-w.js"></script>
            </section>
            <section id="genDrift">
                <h3>Genetic Drift Model</h3>
                <div class="assumptions">finite population size, random mating, no overlapping generations, mutation or selection</div>
                <div id="gen_output" class="output"><h4>Simulation in Progress</h4><div class="text">[this may take a while]...</div></div>
                <script type="text/javascript">
                    const dPopulation = 1024;
                    const dGenerations = 512;
                    const dSimulations = 8;
                    const bottleNeckFlag = true;
                    const bottleNeck = 16;

                    function startDrift() {
                        worker = new Worker ("js/gDrift.js");
                        worker.postMessage([dSimulations, dGenerations, dPopulation, bottleNeck, bottleNeckFlag]);
                        worker.onmessage = function (event) {
                            let output = document.getElementById('gen_output');
                            output.innerHTML = '<h4>Effective Population</h4>' + '<div class="text">' + event.data[1] + '</div>';
                            draw_line_chart (output, event.data[0], "generation", "p", []);
                        };
                    }
                    startDrift();
                </script>
            </section>
            <section id="mutation">
                <h3>Mutation Model</h3>
                <div class="assumptions">finite population size, random mating, no overlapping generations, genetic drift or selection</div>
                <div id="mut_parOutput" class="output"><h4>Simulation in Progress</h4><div class="text">[this may take a while]...</div></div>
                <div id="mut_textOutput" class="textOutput"></div>
                <script type="text/javascript">
                    const mGenerations = 8;
                    const mRate = 0.000055;
                    const seqLength = 16;
                    const numSeq = 64;

                    function outputSequence(output, originalSequence, sequences) {
                        output.innerHTML = '<ul>';
                        for (let i = 0; i < numSeq; i++) {
                            let item = isEqual(originalSequence, sequences[i]) ? '<li>' : '<li class="mutated">';
                            item += sequences[i];
                            output.innerHTML += item + '</li>';
                        }
                        output.innerHTML += '</ul>';
                    }

                    function startMutation() {
                        worker = new Worker ("js/mutation.js");
                        worker.postMessage([mGenerations, mRate, seqLength, numSeq]);
                        worker.onmessage = function(event) {
                            let output = document.getElementById("mut_parOutput");
                            output.innerHTML = '<h4>Mutation Rate</h4>' + '<div class="text">' + mRate + ' per base & generation</div>';
                            output.innerHTML += '<h4>Generations</h4>' + '<div class="text">' + mGenerations + '</div>';
                            outputSequence(document.getElementById("mut_textOutput") , event.data[2], event.data[0]);
                            output.innerHTML += '<h4>Mutations</h4>' + '<div class="text">' + event.data[1] + '/' + numSeq + '</div>';
                        };
                    }
                    startMutation();
                </script>
            </section>
            <section id="fixation">
                <h3>Allele Fixation Model</h3>
                <div class="assumptions">finite population size, random mating, no selection or overlapping generations</div>
                <div id="fix_output" class="output"><h4>Simulation in Progress</h4><div class="text">[this may take a while]...</div></div>
                <script type="text/javascript">
                    const fSimulations = 10000;
                    const fPopulation = 100;

                    function startFixation() {
                        let output = document.getElementById('fix_output')
                        worker = new Worker ("js/fixation.js");
                        worker.postMessage([fSimulations, fPopulation]);
                        worker.onmessage = function(e) {
                            var data = e.data;
                            output.innerHTML = '<h4>Fixations / Simulations (p)</h4>' + '<div class="text">' + (data[0]/fSimulations) + '</div>';
                            output.innerHTML += '<h4>Average Fixation Runtime</h4>' + '<div class="text">' + precisionRound(data[1]/data[0], 2) + '</div>';
                        };
                    }
                    startFixation();
                </script>
            </section>
            <section id="migration">
                <h3>Migration Spatial Model</h3>
                <div class="assumptions">finite population size, no selection or overlapping generations</div>
                <div id="mig_output" class="output"><h4>Simulation in Progress</h4><div class="text">[this may take a while]...</div></div>
                <button id="mig_button" onclick="startMigration()">Start Simulation</button>
                <div id="mig_parOutput" class="output"></div>
                <script type="text/javascript">
                    const mGridSide = 30;
                    const maxMatingDistance = 1;

                    var mInitFlag = true; 

                    function initMigration() {
                        let output = document.getElementById('mig_output');
                        initWorker = new Worker ("js/spatial.js");
                        initWorker.postMessage([mGridSide, maxMatingDistance, true]);
                        initWorker.onmessage = function(e) {
                            output.innerHTML = '<h4>Grid Side</h4>' + '<div class="text">' + gridSide + '</div>';
                            output.innerHTML +=  '<h4>Max Mating Distance</h4>' + '<div class="text">' + maxMatingDistance + '</div>';
                            draw_grid(output, e.data, ["A1A2", "#e8ef8b", "A1A1", "#af2f2f", "A2A2", "#23a025"]);
                        };
                    }
                    initMigration();
                    
                    function startMigration() {
                        let output = document.getElementById('mig_output');
                        let migButton = document.getElementById('mig_button');
                        let parOutput = document.getElementById('mig_parOutput');
                        migWorker = new Worker ("js/spatial.js");
                        migWorker.postMessage([mGridSide, maxMatingDistance, false]);
                        migWorker.onmessage = function(e) {
                            update_grid(output, e.data[0], ["A1A2", "#e8ef8b", "A1A1", "#af2f2f", "A2A2", "#23a025"]);
                            switch (p) {
                                case 0:
                                case 1:
                                    migWorker.terminate();
                            }
                        }
                    }
                </script>             
<!--                       

                    function migrate() {
                        function spaSimulation() {
                            spaGeneration();
                            update_grid(spaOutput, grid, ["A1A2", "#e8ef8b", "A1A1", "#af2f2f", "A2A2", "#23a025"]);
                            spaGenerationsCounter++;
                            writeF();
                            if (p === 1 || p === 0) {
                                clearInterval(sim);
                                migButton.setAttribute('onclick', 'restart()');
                                migButton.innerText = 'Restart';
                            }

                        }
                        migButton.setAttribute('onclick', 'terminate()');
                        migButton.innerText = 'Pause';
                        sim = setInterval(spaSimulation, 1);
                    }

                    startMigration();
                


                    function terminate() {
                        clearInterval(sim);
                        migButton.setAttribute('onclick', 'migrate()');
                        migButton.innerText = 'Unpause';
                    }

                    function restart() {
                        grid = [];
                        spaGenerationsCounter = 0;
                        initGrid();
                        migrate();
                    }
                </script>-->
            </section>
            <section id="selection">
                <h3>Natural Selection Model</h3>
                <div class="assumptions">finite population size, alleles of unequal fitness, no overlapping generations</div>
                <div id="sel_output" class="output"><h4>Simulation in Progress</h4><div class="text">[this may take a while]...</div></div>
                <script type="text/javascript">
                    const sSimulations = 16;
                    const sGenerations = 500;
                    const sPopulation = 1000;
                    const sP = 0.01;
                    const fitness = 1.01;

                    function startSelection() {
                        worker = new Worker ("js/selection.js");
                        worker.postMessage([sSimulations, sGenerations, sPopulation, sP, fitness]);
                        worker.onmessage = function (event) {
                            let output = document.getElementById('sel_output');
                            output.innerHTML = '<h4>Population</h4>' + '<div class="text">' + sPopulation + '</div>';
                            output.innerHTML += '<h4>Selection Factor</h4>' + '<div class="text">' + fitness + '</div>';
                            draw_line_chart (output, event.data, "generation", "p", []);
                        };
                    }
                    startSelection();
                </script>
            </section>
            <section id="infSelection">
                <h3>Infinity Selection Model</h3>
                <div class="assumptions">infinite population size, selection in place</div>
                <div class="controlElements">
                    <input type="text" id="infInput" placeholder="Enter H" value="-0.618033" />
                    <button onclick="startInfSelection()">Run Simulation</button>
                </div>
                <div id="dir_output" class="output"></div>
                <script type="text/javascript">
                    const s = 0.05;
                    const dsGenerations = 500;

                    function startInfSelection() {
                        let output = document.getElementById('dir_output');
                        let h = document.getElementById('infInput').value;
                        output.innerHTML = '<h4>Simulation in Progress</h4><div class="text">[this may take a while]...</div>';
                        worker = new Worker ("js/infSelection.js");
                        worker.postMessage([s, h, dsGenerations]);
                        worker.onmessage = function (event) {
                            output.innerHTML = '<h4>P*</h4><div class="text">' + ((h-1)/(2*h-1)) + '</div>';
                            draw_line_chart (output, event.data[0], "p", "\u0394 p", [], 1, true);
                            draw_line_chart (output, event.data[1], "generation", "p", []);
                        };
                    }

                    startInfSelection();
                </script>
            </section>
            <section id="coevolution">
                <h3>The Matching Alleles Model</h3>
                <div class="assumptions">infinite population size, two evolutionary related sets of alleles</div>
                <div id="co_output"><h4>Simulation in Progress</h4><div class="text">[this may take a while]...</div></div>
                <script type="text/javascript">
                    const cGenerations = 500;
                    const sh = .2;
                    const sp = .5;

                    function startCoevolution() {
                        let output = document.getElementById("co_output");
                        worker = new Worker ("js/coevolution.js");
                        worker.postMessage([cGenerations, sh, sp]);
                        worker.onmessage = function (d) {
                            output.innerHTML = '<h4>SH</h4>' + '<div class="text">' + sh + '</div>';
                            output.innerHTML += '<h4>SP</h4>' + '<div class="text">' + sp + '</div>';
                            draw_line_chart(output, d.data, "Generation", "p", []);
                        };
                    }

                    startCoevolution();
                    //optional TODO: switch population size assumptions
                </script>
            </section>
            <section id="epidemics">
                <h3>Epidemy Model</h3>
                <div class="assumptions"></div>
                <div id="ep_output" class="output"><h4>Simulation in Progress</h4><div class="text">[this may take a while]...</div></div>
                <script type="text/javascript" src="js/epidemics.js"></script>
        </main>
        <footer>
            <h5>based on the edX course: EPFLx: NiC1.0x Nature, in Code: Biology in JavaScript</h5>
            <h4>&#169; 2016 James Bohacek</h4>
    </body>
</html>